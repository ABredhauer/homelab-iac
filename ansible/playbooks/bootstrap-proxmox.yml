---
# ansible/playbooks/bootstrap-proxmox.yml
# Bootstrap Proxmox host - create ansible user, then configure system

# ===== PLAY 1: Create Ansible User (as root) =====
- name: Create Ansible Automation User
  hosts: proxmox_nodes
  become: true
  gather_facts: false
  remote_user: root  # Connect as root initially

  vars:
    ansible_user: root
    ansible_ssh_pass: "{{ PROXMOX_ROOT_PASSWORD }}"  # From Variable Group
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o PreferredAuthentications=password -o PubkeyAuthentication=no'
    semaphore_ssh_public_key: "{{ SEMAPHORE_SSH_PUBLIC_KEY }}"

  tasks:
      # ===== CONNECTION TEST =====
    - name: Test if root connection is possible
      ansible.builtin.command: echo "root_connection_works"
      register: root_connection_test
      ignore_errors: true
      ignore_unreachable: true
      changed_when: false

    - name: Display connection test result
      ansible.builtin.debug:
        msg: |
          Root connection test: {{ 'SUCCESS' if root_connection_test is not failed and root_connection_test is not unreachable else 'FAILED' }}
          {% if root_connection_test is failed or root_connection_test is unreachable %}
          This likely means ansible user is already configured.
          Skipping initial setup tasks.
          {% endif %}

    # ===== INITIAL SETUP BLOCK (only if root connection works) =====
    - name: Perform initial root setup
      when:
        - root_connection_test is not failed
        - root_connection_test is not unreachable
      block:
        - name: Verify we're connecting as root
          ansible.builtin.debug:
            msg: "Connected as root - performing initial setup"

        - name: Display initial connection info
          ansible.builtin.debug:
            msg: "Creating ansible user on {{ inventory_hostname }} (connecting as root)"

        # Cleanup the apt repos before doing anything
        - name: Disable Proxmox enterprise repositories (deb822 format)
          ansible.builtin.deb822_repository:
            name: pve-enterprise
            state: absent

        - name: Disable the Ceph enterprise repository (deb822 format)
          ansible.builtin.deb822_repository:
            name: ceph
            state: absent

        - name: Configure Proxmox no-subscription repository
          ansible.builtin.deb822_repository:
            name: proxmox
            types: deb
            state: present
            uris: http://download.proxmox.com/debian/pve
            suites: trixie
            components: pve-no-subscription
            signed_by: /usr/share/keyrings/proxmox-archive-keyring.gpg

        - name: Configure the Ceph no-subscription repository (deb822 format)
          ansible.builtin.deb822_repository:
            name: ceph
            types: deb
            state: present
            uris: http://download.proxmox.com/debian/ceph-squid
            suites: trixie
            components: no-subscription
            signed_by: /usr/share/keyrings/proxmox-archive-keyring.gpg

        # ===== NOW SAFE TO RUN APT =====
        - name: Update apt cache (enterprise repos now disabled)
          ansible.builtin.apt:
            update_cache: true
          register: apt_update
          retries: 3
          delay: 5
          until: apt_update is success

        - name: Install essential packages
          ansible.builtin.apt:
            name:
              - sudo
              - python3
              - python3-apt
            state: present

        - name: Create ansible user
          ansible.builtin.user:
            name: ansible
            comment: "Ansible Automation User"
            shell: /bin/bash
            create_home: true
            groups: sudo
            append: true
            state: present

        - name: Add ansible user to sudoers with NOPASSWD
          ansible.builtin.copy:
            dest: /etc/sudoers.d/ansible
            content: |
              # Ansible automation user - passwordless sudo
              ansible ALL=(ALL) NOPASSWD: ALL
            mode: '0440'
            validate: 'visudo -cf %s'

        - name: Create .ssh directory for ansible user
          ansible.builtin.file:
            path: /home/ansible/.ssh
            state: directory
            owner: ansible
            group: ansible
            mode: '0700'

        - name: Add Semaphore SSH public key to ansible user
          ansible.posix.authorized_key:
            user: ansible
            state: present
            key: "{{ semaphore_ssh_public_key }}"
            comment: "Semaphore Automation Key"

        - name: Also add GitHub keys to ansible user (for manual access)
          ansible.posix.authorized_key:
            user: ansible
            state: present
            key: https://github.com/ABredhauer.keys

        - name: Verify ansible user can sudo
          ansible.builtin.command: sudo -n -l -U ansible
          register: sudo_check
          changed_when: false

        - name: Display user creation complete
          ansible.builtin.debug:
            msg: "✓ Ansible user created and configured"

        - name: Disable root password authentication
          ansible.builtin.lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?PermitRootLogin'
            line: 'PermitRootLogin prohibit-password'
            state: present
          notify: Reload sshd

        - name: Disable password authentication entirely
          ansible.builtin.lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?PasswordAuthentication'
            line: 'PasswordAuthentication no'
            state: present
          notify: Reload sshd

  handlers:
    - name: Reload sshd
      ansible.builtin.systemd:
        name: sshd
        state: reloaded

# ===== PLAY 2: Bootstrap System (as ansible user) =====
- name: Bootstrap Proxmox Host
  hosts: proxmox_nodes
  become: true
  gather_facts: true  # Required for ansible_date_time and system facts
  remote_user: ansible  # Now connect as ansible user

  vars:
    # Get config from inventory
    target_hostname: "{{ inventory_hostname }}"
    node_id: "{{ hostvars[inventory_hostname].node_id }}"
    node_description: "{{ hostvars[inventory_hostname].node_description }}"
    primary_mac: "{{ hostvars[inventory_hostname].primary_mac }}"
    network_config: "{{ hostvars[inventory_hostname].network_interfaces }}"
    target_ip: "{{ network_config.primary.static_ip }}"

    # Semaphore API (from Variable Group)
    semaphore_url: "{{ SEMAPHORE_WEB_ROOT }}"
    semaphore_project_id: "{{ SEMAPHORE_PROJECT_ID }}"
    semaphore_inventory_id: "{{ SEMAPHORE_INVENTORY_ID }}"
    semaphore_api_token: "{{ SEMAPHORE_API_TOKEN }}"

  tasks:
    - name: Display bootstrap information
      ansible.builtin.debug:
        msg: |
          Bootstrapping Proxmox Host
          ==========================
          Target Hostname: {{ target_hostname }}
          Node ID: {{ node_id }}
          Description: {{ node_description }}
          Current IP: {{ ansible_default_ipv4.address }}
          Target IP: {{ target_ip }}
          Primary MAC: {{ primary_mac }}

    # ===== HOSTNAME CONFIGURATION =====

    - name: Only set the hostname if we haven't already done it
      when: ansible_hostname != target_hostname
      block:

        - name: Set system hostname
          ansible.builtin.hostname:
            name: "{{ target_hostname }}"

        # ===== NETWORK & RESOLUTION CONFIG (DHCP SUPPORT) =====
        # Reference: https://free-pmx.org/guides/dhcp-single/

        - name: Install networking helper packages
          ansible.builtin.apt:
            name:
              - isc-dhcp-client  # Required for Proxmox 9+ DHCP
              - libnss-myhostname # Resolves hostname to local IP dynamically
            state: present

        - name: Configure IPv4 Precedence in /etc/gai.conf
          ansible.builtin.blockinfile:
            path: /etc/gai.conf
            create: true
            mode: '0644'
            block: |
              # Prefer IPv4 over IPv6 (Critical for Proxmox DHCP)
              precedence ::ffff:0:0/96 100

              # Optional: Prefer specific subnet if multiple exist
              scopev4 ::ffff:192.168.1.0/120 1

        - name: Configure /etc/hosts - Remove temp entries
          ansible.builtin.lineinfile:
            path: /etc/hosts
            regexp: ".*pve-temp.*"
            state: absent

        - name: Configure /etc/hosts for DHCP Setup
          ansible.builtin.lineinfile:
            path: /etc/hosts
            regexp: '^127\.0\.1\.1'
            state: absent
          # We REMOVE 127.0.1.1 because libnss-myhostname handles resolution
          # based on the IP assigned by DHCP.
          # This prevents the "split brain" where /etc/hosts says one thing
          # but the interface has a different IP.

        # ===== REBOOT to apply new hostname =====

        - name: Reboot the host to apply new hostname
          ansible.builtin.reboot:
            msg: "Rebooting to apply new hostname"
            reboot_timeout: 300
            test_command: hostnamectl | grep "{{ target_hostname }}"

        - name: Verify hostname resolution works
          ansible.builtin.command: hostname -i
          register: hostname_check
          changed_when: false
          failed_when: "'127.0.0.1' in hostname_check.stdout"
          # We want it to resolve to the LAN IP (e.g., 192.168.1.x), NOT localhost

    # ===== REPOSITORY CONFIGURATION =====

    # ===== PACKAGE MANAGEMENT =====
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install essential packages
      ansible.builtin.apt:
        name:
          - sudo
          - curl
          - jq
          - python3
          - openssh-server
          - wget
          - git
          - htop
          - vim
          - net-tools
          - tree
          - rsync
          - screen
          - tmux
          - python3-pip
          - fail2ban
          - ufw
          - nut-client
          - fwupd
          - isc-dhcp-client
          - libnss-myhostname
        state: present

    - name: Perform full system upgrade
      ansible.builtin.apt:
        upgrade: dist
        autoremove: true
        autoclean: true

    # ===== PROXMOX CONFIGURATION =====
    - name: Remove subscription nag
      ansible.builtin.replace:
        path: /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
        regexp: '(data\.status !== .active.)'
        replace: 'false'
      register: remove_subscription_result
      failed_when: >
        remove_subscription_result is failed and
        ('No such file' not in (remove_subscription_result.msg | default('')) and
         'No such file or directory' not in (remove_subscription_result.msg | default('')))

    - name: Enable Proxmox services
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: true
        state: started
      loop:
        - pveproxy
        - pvedaemon
        - pvestatd
        - pve-ha-lrm
        - pve-ha-crm
        - corosync

    # ===== SYSTEM CONFIGURATION =====
    - name: Configure timezone
      community.general.timezone:
        name: Australia/Brisbane

    - name: Configure NTP
      ansible.builtin.copy:
        dest: /etc/systemd/timesyncd.conf
        content: |
          [Time]
          NTP=0.au.pool.ntp.org 1.au.pool.ntp.org 2.au.pool.ntp.org
          FallbackNTP=ntp.ubuntu.com
        mode: '0644'
      notify: Restart timesyncd

    # ===== COMPLETION MARKERS =====
    - name: Create bootstrap completion file
      ansible.builtin.copy:
        dest: /opt/ansible-bootstrap-complete
        content: |
          Ansible Bootstrap Complete
          ==========================
          Hostname: {{ target_hostname }}
          Node ID: {{ node_id }}
          Description: {{ node_description }}
          Primary MAC: {{ primary_mac }}
          IP Address: {{ ansible_default_ipv4.address }}
          Bootstrapped: {{ ansible_date_time.iso8601 }}
          By: Ansible Semaphore
        mode: '0644'

    - name: Create node identity file
      ansible.builtin.copy:
        dest: /opt/homelab-node-identity
        content: "{{ target_hostname }}"
        mode: '0644'

    # ===== UPDATE LIFECYCLE STATE =====
    - name: Update inventory in Semaphore
      delegate_to: localhost
      become: false
      connection: local
      when: not ansible_check_mode
      block:
        - name: Fetch current inventory from Semaphore
          ansible.builtin.uri:
            url: "{{ semaphore_url }}/api/project/{{ semaphore_project_id }}/inventory/{{ semaphore_inventory_id }}"
            method: GET
            headers:
              Authorization: "Bearer {{ semaphore_api_token }}"
            return_content: true
            status_code: 200
          register: inventory_fetch

        - name: Parse inventory
          ansible.builtin.set_fact:
            current_inv: "{{ inventory_fetch.json.inventory | from_yaml }}"
            inv_meta: "{{ inventory_fetch.json }}"

        - name: Update host lifecycle state to bootstrapped
          ansible.builtin.set_fact:
            updated_inv: >-
              {{
                current_inv | combine({
                  'all': {
                    'children': {
                      'proxmox_nodes': {
                        'hosts': current_inv.all.children.proxmox_nodes.hosts | combine({
                          inventory_hostname: current_inv.all.children.proxmox_nodes.hosts[inventory_hostname] | combine({
                            'lifecycle_state': 'bootstrapped',
                            'bootstrapped_at': ansible_date_time.iso8601,
                            'ansible_host': target_ip
                          })
                        })
                      }
                    }
                  }
                }, recursive=True)
              }}

        - name: Save updated inventory to Semaphore
          ansible.builtin.uri:
            url: "{{ semaphore_url }}/api/project/{{ semaphore_project_id }}/inventory/{{ semaphore_inventory_id }}"
            method: PUT
            headers:
              Authorization: "Bearer {{ semaphore_api_token }}"
              Content-Type: "application/json"
            body_format: json
            body: "{{ inv_meta | combine({'inventory': updated_inv | to_nice_yaml}) }}"
            status_code: 204

    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          ✓ Bootstrap complete for {{ target_hostname }}
          ✓ Hostname configured
          ✓ Repositories updated
          ✓ System packages upgraded
          ✓ Proxmox services enabled
          ✓ Lifecycle state: bootstrapped

          Next: Configure network interfaces and join cluster

  handlers:
    - name: Restart timesyncd
      ansible.builtin.systemd:
        name: systemd-timesyncd
        state: restarted
        enabled: true
