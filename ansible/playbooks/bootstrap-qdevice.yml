---
- name: Bootstrap Raspberry Pi for Ansible Management
  hosts: qdevice
  become: true
  gather_facts: false
  remote_user: root

  vars:
    ansible_user: root
    ansible_ssh_pass: "{{ PI_ROOT_PASSWORD }}"  # From Variable Group
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o PreferredAuthentications=password -o PubkeyAuthentication=no'
    semaphore_ssh_public_key: "{{ SEMAPHORE_SSH_PUBLIC_KEY }}"
    ansible_user_name: ansible
    github_user: "ABredhauer"

  tasks:
    # ===== CONNECTION TEST =====
    - name: Test if root connection is possible
      ansible.builtin.command: echo "root_connection_works"
      register: root_connection_test
      ignore_errors: true
      ignore_unreachable: true
      changed_when: false

    - name: Display connection test result
      ansible.builtin.debug:
        msg: |
          Root connection test: {{ 'SUCCESS' if root_connection_test is not failed and root_connection_test is not unreachable else 'FAILED' }}
          {% if root_connection_test is failed or root_connection_test is unreachable %}
          This likely means ansible user is already configured.
          Skipping initial setup tasks.
          {% endif %}

    # --- Create ansible user ---
    - name: Create ansible user
      ansible.builtin.user:
        name: "{{ ansible_user_name }}"
        groups: sudo
        shell: /bin/bash
        create_home: true
        state: present

    - name: Add Semaphore SSH public key to ansible user
      ansible.posix.authorized_key:
        user: "{{ ansible_user_name }}"
        state: present
        key: "{{ semaphore_ssh_public_key }}"
        comment: "Semaphore Automation Key"

    - name: Also add GitHub keys to ansible user (for manual access)
      ansible.posix.authorized_key:
        user: "{{ ansible_user_name }}"
        state: present
        key: https://github.com/{{ github_user }}.keys

    - name: Configure sudo without password for ansible user
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/99-ansible
        line: "{{ ansible_user_name }} ALL=(ALL) NOPASSWD:ALL"
        create: true
        mode: "0440"
        state: present


- name: Bootstrap Managed Pi for QDevice use
  hosts: qdevice
  become: true
  gather_facts: true
  remote_user: ansible

  vars:
    ansible_user_name: ansible
    github_user: "ABredhauer"

  tasks:
    # --- Install prerequisites ---
    - name: Update package cache
      ansible.builtin.apt:
        update_cache: true

    - name: Install corosync-qnetd
      ansible.builtin.apt:
        name: corosync-qnetd
        state: present

    - name: Check if coroqnetd user already exists
      ansible.builtin.getent:
        database: passwd
        key: coroqnetd
      ignore_errors: true
      register: coroqnetd_check

    - name: Create dedicated qnetd user (if not exists)
      ansible.builtin.user:
        name: coroqnetd
        system: true
        shell: /sbin/nologin
        home: /var/lib/coroqnetd
        create_home: true
        state: present
      when: coroqnetd_check.failed  # Only runs if user doesn't exist
      
    - name: Set qnetd directories ownership
      ansible.builtin.file:
        path: "{{ item }}"
        owner: coroqnetd
        group: coroqnetd
        mode: "0750"
        state: directory
      loop:
        - /etc/corosync/qnetd
        - /var/run/corosync-qnetd

    # --- Configure SSH for Proxmox qdevice setup ---
    - name: Temporarily enable root SSH access
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitRootLogin'
        line: "PermitRootLogin prohibit-password"
        state: present
        backup: true
      notify: Reload SSHD

    - name: Ensure PubkeyAuthentication is enabled
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PubkeyAuthentication'
        line: "PubkeyAuthentication yes"
        state: present
      notify: Reload SSHD

    - name: Copy Semaphore SSH public key to root's authorized_keys
      ansible.posix.authorized_key:
        user: root
        state: present
        key: "{{ semaphore_ssh_public_key }}"
        manage_dir: true
        comment: "Semaphore - for qdevice setup"

    # --- Configure corosync-qnetd service ---
    - name: Configure qnetd to run as non-root user
      ansible.builtin.lineinfile:
        path: /etc/default/corosync-qnetd
        regexp: '^#?COROSYNC_QNETD_RUNAS'
        line: "COROSYNC_QNETD_RUNAS=coroqnetd"
        create: true
        mode: "0644"

    - name: Enable and start corosync-qnetd
      ansible.builtin.systemd:
        name: corosync-qnetd
        enabled: true
        state: started

    - name: Verify qnetd is listening on port 5403
      ansible.builtin.wait_for:
        port: 5403
        timeout: 30
        state: started

    - name: Create bootstrap completion marker
      ansible.builtin.copy:
        content: |
          # Raspberry Pi Bootstrap Complete
          # Date: {{ ansible_date_time.iso8601 }}
          # Ansible User: {{ ansible_user_name }}
          # Root SSH: Temporarily enabled for 'pvecm qdevice setup'
          # Action Required: Run disable-qdevice-root.yml after Proxmox qdevice setup
        dest: /opt/pi-bootstrap-complete
        mode: "0644"

  handlers:
    - name: Reload SSHD
      ansible.builtin.systemd:
        name: ssh
        state: reloaded
