# ansible/playbooks/cluster-formation.yml
# Form Proxmox cluster with dual-link corosync + QDevice quorum
# This playbook should run AFTER bootstrap-proxmox.yml on both nodes

---
- name: Form Proxmox HA Cluster
  hosts: proxmox_cluster_masters  # Only run on node 1 initially
  become: true
  gather_facts: true

  vars:
    cluster_name: "homelab-cluster"
    cluster_master: "pve-node1"
    cluster_master_ip_mgmt: "192.168.10.230"
    cluster_master_mgmt_hostname: "pve-node1.homelab.bredhauer.net"
    cluster_master_internal_hostname: "pve-node1.internal.bredhauer.net"
    cluster_members:
      - hostname: "pve-node2"
        mgmt_ip: "192.168.10.232"
        mgmt_hostname: "pve-node2.homelab.bredhauer.net"
        internal_hostname: "pve-node2.internal.bredhauer.net"

  tasks:
    - name: Display cluster formation plan
      ansible.builtin.debug:
        msg: |
          Proxmox Cluster Formation Plan
          ==============================
          Cluster Name: {{ cluster_name }}
          Master Node: {{ cluster_master }}
          Master Mgmt IP: {{ cluster_master_ip_mgmt }}

          Cluster Members:
          {% for member in cluster_members %}
            - {{ member.hostname }} ({{ member.mgmt_ip }})
          {% endfor %}

          This playbook will:
          1. Create cluster on master node
          2. Join member nodes to cluster
          3. Add redundant corosync link (Link 1)
          4. Setup QDevice for quorum voting

    # ===== PHASE 1: CREATE CLUSTER ON MASTER =====
    - name: Check if cluster already exists
      ansible.builtin.command: pvecm status
      register: cluster_check
      changed_when: false
      failed_when: false
      ignore_errors: true

    - name: Create cluster (if not already created)
      when:
        - cluster_check is failed or cluster_check.rc != 0
      block:
        - name: Create Proxmox cluster
          ansible.builtin.command: >
            pvecm create {{ cluster_name }} --link0 {{ cluster_master_mgmt_hostname }} --link1 {{ cluster_master_internal_hostname }}
          register: cluster_create
          changed_when: cluster_create.rc == 0
          failed_when: >
            cluster_create.rc != 0 and
            'already exists' not in cluster_create.stderr

        - name: Wait for cluster services to stabilize
          ansible.builtin.pause:
            seconds: 10

        - name: Verify cluster creation
          ansible.builtin.command: pvecm status
          register: cluster_status
          changed_when: false

        - name: Display cluster creation result
          ansible.builtin.debug:
            msg: "{{ cluster_status.stdout }}"

    # # ===== PHASE 3: GET CERTIFICATE FINGERPRINT =====
    # - name: Get cluster certificate fingerprint
    #   block:
    #     - name: Extract certificate fingerprint for joining nodes
    #       ansible.builtin.shell: |
    #         set -o pipefail
    #         pvenode cert info --output-format json | jq -r '.[] | select(.filename=="pve-ssl.pem") | .fingerprint'
    #       register: cluster_fingerprint
    #       changed_when: false

    #     - name: Store fingerprint for member nodes
    #       ansible.builtin.set_fact:
    #         cluster_cert_fingerprint: "{{ cluster_fingerprint.stdout }}"

    #     - name: Display fingerprint
    #       ansible.builtin.debug:
    #         msg: |
    #           Certificate Fingerprint (for joining nodes):
    #           {{ cluster_cert_fingerprint }}

    # # ===== PHASE 4: SETUP QDEVICE =====
    # - name: Setup QDevice for external quorum voting
    #   block:
    #     - name: Install QDevice package
    #       ansible.builtin.apt:
    #         name: corosync-qdevice
    #         state: present

    #     - name: Setup QDevice (requires SSH access to QDevice host)
    #       ansible.builtin.command: |
    #         pvecm qdevice setup {{ qdevice_ip }}
    #       register: qdevice_setup
    #       changed_when: qdevice_setup.rc == 0 and 'already configured' not in qdevice_setup.stderr
    #       failed_when: >
    #         qdevice_setup.rc != 0 and
    #         'already configured' not in qdevice_setup.stderr
    #       ignore_errors: true

    #     - name: Wait for QDevice to register
    #       ansible.builtin.pause:
    #         seconds: 10

    #     - name: Verify QDevice registration
    #       ansible.builtin.command: pvecm status
    #       register: qdevice_status
    #       changed_when: false

    #     - name: Display final cluster status with QDevice
    #       ansible.builtin.debug:
    #         msg: "{{ qdevice_status.stdout }}"

    # ===== FINAL VERIFICATION =====
    - name: Final cluster health check
      block:
        - name: Verify cluster quorum
          ansible.builtin.command: pvecm status
          register: final_status
          changed_when: false

        - name: Create cluster completion marker
          ansible.builtin.copy:
            dest: /opt/cluster-formation-complete
            content: |
              Proxmox Cluster Formation Complete
              ===================================
              Cluster Name: {{ cluster_name }}
              Nodes: 2
              QDevice: Configured
              Quorum: 3 votes (2 required)
              Timestamp: {{ ansible_date_time.iso8601 }}

              Corosync Links:
                Link 0: {{ cluster_master_mgmt_hostname }} (USB 2.5GbE)
                Link 1: pve-node1.internal.bredhauer.net (Built-in 1GbE)

              Final Status:
              {{ final_status.stdout }}
            mode: '0644'

        - name: Display completion message
          ansible.builtin.debug:
            msg: |
              ✓ Proxmox Cluster Formation Complete!
              ✓ Cluster Name: {{ cluster_name }}
              ✓ Quorum: 3 votes (2 required)
              ✓ Links: 2 (USB primary, Built-in failover)
              ✓ QDevice: Configured and voting

              Next: Configure shared storage (NFS/Ceph)

# ===== PLAY 2: PREPARE SSH KEY TRUST BETWEEN NODES =====
- name: Prepare SSH Key Trust Between Proxmox Nodes
  hosts: proxmox_cluster_members
  become: true
  gather_facts: true

  tasks:
    - name: Ensure root SSH directory exists
      ansible.builtin.file:
        path: /root/.ssh
        state: directory
        mode: '0700'
        owner: root
        group: root

    - name: Check if root SSH key exists
      ansible.builtin.stat:
        path: /root/.ssh/id_rsa
      register: root_ssh_key

    - name: Generate SSH key for root (if missing)
      ansible.builtin.command: ssh-keygen -t rsa -b 4096 -f /root/.ssh/id_rsa -N ''
      args:
        creates: /root/.ssh/id_rsa
      when: not root_ssh_key.stat.exists

    - name: Fetch public keys from all nodes
      ansible.builtin.slurp:
        src: /root/.ssh/id_rsa.pub
      register: node_public_keys

    - name: Build authorized_keys for all nodes
      ansible.builtin.set_fact:
        all_public_keys: "{{
          groups['proxmox_cluster_members']
          | map('extract', hostvars)
          | map(attribute='node_public_keys')
          | map(attribute='content')
          | map('b64decode')
          | list
          }}"
      delegate_to: "{{ groups['proxmox_cluster_members'][0] }}"

    - name: Deploy authorized_keys to all nodes
      ansible.posix.authorized_key:
        user: root
        state: present
        key: "{{ item }}"
      loop: "{{ all_public_keys }}"
      loop_control:
        label: "{{ item.split()[-1] | default('key') }}"

    - name: Add all cluster nodes to known_hosts
      ansible.builtin.known_hosts:
        name: "{{ hostvars[item].ansible_host }}"
        key: "{{ lookup('pipe', 'ssh-keyscan -H ' + hostvars[item].ansible_host) }}"
        state: present
      loop: "{{ groups['proxmox_cluster_members'] }}"
      when: item != inventory_hostname

    - name: Test SSH connectivity between nodes
      ansible.builtin.command: "ssh -o BatchMode=yes -o StrictHostKeyChecking=no root@{{ hostvars[item].ansible_host }} hostname"
      loop: "{{ groups['proxmox_cluster_members'] }}"
      when: item != inventory_hostname
      register: ssh_test
      changed_when: false
      failed_when: ssh_test.rc != 0

    - name: Display SSH test results
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }} can SSH to {{ item.item }}: {{ item.stdout }}"
      loop: "{{ ssh_test.results }}"
      when: not item.skipped | default(false)


# ===== PLAY 3: Join Member Nodes to Cluster =====
- name: Join Member Nodes to Cluster
  hosts: proxmox_cluster_members
  serial: 1  # Join nodes one at a time to avoid issues
  become: true
  gather_facts: true

  vars:
    cluster_master_hostname: "pve-node1.homelab.bredhauer.net"

  tasks:
    - name: Display node join plan
      ansible.builtin.debug:
        msg: |
          Joining {{ inventory_hostname }} to cluster
          ==========================================
          Master: {{ cluster_master_hostname }}
          This Node: {{ inventory_hostname }}
          Link 0: {{ inventory_hostname }}.homelab.bredhauer.net
          Link 1: {{ inventory_hostname }}.internal.bredhauer.net

    - name: Check if node is already in cluster
      ansible.builtin.command: pvecm status
      register: node_cluster_check
      changed_when: false
      failed_when: false
      ignore_errors: true

    - name: Join node to cluster (if not already member)
      when:
        - node_cluster_check is failed or 'Quorate' not in node_cluster_check.stdout
      block:
        - name: Install QDevice package on member
          ansible.builtin.apt:
            name: corosync-qdevice
            state: present

        - name: Get cluster fingerprint from master
          ansible.builtin.shell: |
            set -o pipefail
            pvenode cert info --output-format json | jq -r '.[] | select(.filename=="pve-ssl.pem") | .fingerprint'
          register: cluster_fingerprint
          delegate_to: "{{ groups['proxmox_cluster_masters'][0] }}"
          become: true
          changed_when: false

        - name: Add node to cluster with dual links
          ansible.builtin.command: >
            pvecm add {{ cluster_master_hostname }}
            --link0 {{ inventory_hostname }}.homelab.bredhauer.net
            --link1 {{ inventory_hostname }}.internal.bredhauer.net
            --fingerprint
            {{ cluster_fingerprint.stdout }}
          args:
            stdin: "{{ PROXMOX_ROOT_PASSWORD }}"
          register: node_join
          changed_when: node_join.rc == 0
          failed_when: >
            node_join.rc != 0 and
            'already part of cluster' not in node_join.stderr

        - name: Wait for cluster sync
          ansible.builtin.pause:
            seconds: 15

        - name: Verify node joined successfully
          ansible.builtin.command: pvecm status
          register: node_join_status
          changed_when: false

        - name: Display node join result
          ansible.builtin.debug:
            msg: "{{ node_join_status.stdout }}"

        - name: Create node join completion marker
          ansible.builtin.copy:
            dest: /opt/cluster-join-complete
            content: |
              Node Cluster Join Complete
              ==========================
              Node: {{ inventory_hostname }}
              Joined: {{ ansible_date_time.iso8601 }}

              Links:
                Link 0 (Mgmt): {{ inventory_hostname }}.homelab.bredhauer.net
                Link 1 (Prod): {{ inventory_hostname }}.internal.bredhauer.net

              Cluster Status:
              {{ node_join_status.stdout }}
            mode: '0644'

    - name: Final node health check
      block:
        - name: Verify corosync is running
          ansible.builtin.systemd:
            name: corosync
            state: started
            enabled: true

        - name: Verify pve-cluster is running
          ansible.builtin.systemd:
            name: pve-cluster
            state: started
            enabled: true

        - name: Check pvecm status
          ansible.builtin.command: pvecm status
          register: final_node_status
          changed_when: false

        - name: Display final node status
          ansible.builtin.debug:
            msg: "{{ final_node_status.stdout }}"


# ===== PLAY: Deploy Proxmox Nodes' SSH Keys to QDevice =====
- name: Deploy Proxmox SSH Keys to QDevice
  hosts: qdevice
  become: true
  gather_facts: true

  tasks:
    - name: Display QDevice SSH setup plan
      ansible.builtin.debug:
        msg: |
          QDevice SSH Access Setup
          ========================
          QDevice: {{ inventory_hostname }}

          This will fetch and deploy all Proxmox nodes' public keys to this QDevice

    - name: Ensure root .ssh directory exists
      ansible.builtin.file:
        path: /root/.ssh
        state: directory
        mode: '0700'
        owner: root
        group: root

    - name: Fetch public keys from all Proxmox nodes
      ansible.builtin.slurp:
        src: /root/.ssh/id_rsa.pub
      register: proxmox_public_keys
      delegate_to: "{{ item }}"
      loop: "{{ groups['proxmox_cluster_members'] }}"
      loop_control:
        label: "Fetching key from {{ item }}"

    - name: Display fetched keys
      ansible.builtin.debug:
        msg: |
          Fetched key from {{ item.item }}:
          {{ item.content | b64decode | trim | truncate(80) }}...
      loop: "{{ proxmox_public_keys.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Initialize authorized_keys file
      ansible.builtin.file:
        path: /root/.ssh/authorized_keys
        state: touch
        mode: '0600'
        owner: root
        group: root

    - name: Deploy each Proxmox node's public key to QDevice authorized_keys
      ansible.builtin.lineinfile:
        path: /root/.ssh/authorized_keys
        line: "{{ item.content | b64decode | trim }}"
        state: present
      loop: "{{ proxmox_public_keys.results }}"
      loop_control:
        label: "Adding key from {{ item.item }}"
      register: key_add_result

    - name: Display key addition results
      ansible.builtin.debug:
        msg: |
          Node: {{ item.item }}
          Changed: {{ item.changed }}
      loop: "{{ key_add_result.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Verify all keys in authorized_keys
      ansible.builtin.shell: cat /root/.ssh/authorized_keys | wc -l
      register: key_count
      changed_when: false

    - name: Display final key count
      ansible.builtin.debug:
        msg: |
          authorized_keys now contains {{ key_count.stdout }} lines.
          Expected: {{ groups['proxmox_cluster_members'] | length }} keys

    - name: Show authorized_keys content
      ansible.builtin.shell: cat /root/.ssh/authorized_keys
      register: auth_keys_content
      changed_when: false

    - name: Display authorized_keys
      ansible.builtin.debug:
        msg: |
          Current authorized_keys:
          {{ auth_keys_content.stdout }}

    - name: Test SSH connectivity from each Proxmox node
      ansible.builtin.command: "ssh -o BatchMode=yes -o StrictHostKeyChecking=no root@192.168.1.164 hostname"
      register: qdevice_ssh_test
      delegate_to: "{{ item }}"
      vars:
        ansible_user: root
      loop: "{{ groups['proxmox_cluster_members'] }}"
      loop_control:
        label: "Testing {{ item }} → QDevice"
      changed_when: false
      failed_when: qdevice_ssh_test.rc != 0

    - name: Display SSH test results
      ansible.builtin.debug:
        msg: "✓ {{ item.item }} can SSH to QDevice: {{ item.stdout }}"
      loop: "{{ qdevice_ssh_test.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Display completion message
      ansible.builtin.debug:
        msg: |

          ✓ QDevice SSH Access Fully Configured!
          ======================================

          All {{ groups['proxmox_cluster_all'] | length }} Proxmox nodes can now SSH to QDevice.
          Ready for: pvecm qdevice setup

# PLAY 4: Add QDevice (ONLY AFTER 2+ NODES)
- name: Configure QDevice
  hosts: proxmox_cluster_masters
  become: true

  vars:
  # QDevice configuration
    qdevice_ip: "192.168.1.164"  # Your Raspberry Pi
    qdevice_fingerprint: ""  # Will be populated after cluster creation

  tasks:
    - name: Get cluster node list
      ansible.builtin.command: pvecm nodes
      register: cluster_nodes
      changed_when: false

    - name: Display cluster nodes
      ansible.builtin.debug:
        msg: "{{ cluster_nodes.stdout_lines }}"

    - name: Count nodes in cluster
      ansible.builtin.set_fact:
        node_count: "{{ cluster_nodes.stdout_lines | select('search', '^\\s*\\d+') | list | length }}"

    - name: Verify even number of nodes (required for QDevice)
      ansible.builtin.assert:
        that:
          - (node_count | int) % 2 == 0
          - (node_count | int) >= 2
        fail_msg: "QDevice requires even number of nodes. Found: {{ node_count }} (odd number not supported)"
        success_msg: "Cluster has {{ node_count }} nodes (even) - ready for QDevice"

    - name: Check if QDevice already configured
      ansible.builtin.command: pvecm status
      register: qdevice_check
      changed_when: false
      failed_when: false

    - name: Setup QDevice
      ansible.builtin.command: pvecm qdevice setup {{ qdevice_ip }}
      args:
        stdin: "{{ PI_ROOT_PASSWORD }}"
      when: "'Qdevice' not in qdevice_check.stdout"
      register: qdevice_setup
      changed_when: qdevice_setup.rc == 0
      failed_when: >
        qdevice_setup.rc != 0 and
        'already configured' not in qdevice_setup.stderr

    - name: Verify QDevice status
      ansible.builtin.command: pvecm status
      register: final_status
      changed_when: false

    - name: Display final cluster status
      ansible.builtin.debug:
        msg: "{{ final_status.stdout_lines }}"
